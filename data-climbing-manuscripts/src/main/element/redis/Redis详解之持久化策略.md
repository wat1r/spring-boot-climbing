## Redis详解之持久化策略

### 前言

由于` Redis` 是一个内存数据库，所谓内存数据库，就是将数据库中的内容保存在内存中，这与传统的`MySQL`，`Oracle`等关系型数据库直接将内容保存到硬盘中相比，内存数据库的读写效率比传统数据库要快的多（内存的读写效率远远大于硬盘的读写效率）。但是保存在内存中也随之带来了一个缺点，一旦断电或者宕机，那么内存数据库中的数据将会全部丢失。
为了解决这个缺点，Redis提供了将内存数据持久化到硬盘，以及用持久化文件来恢复数据库数据的功能。Redis 支持两种形式的持久化，一种是RDB快照（`snapshotting`），另外一种是`AOF`（`append-only-file`）



### RDB

#### 配置

`redis.conf`配置文件下的一些属性：

　- **save：**这里是用来配置触发` Redis`的 `RDB` 持久化条件，也就是什么时候将内存中的数据保存到硬盘。比如“`save m n`”。表示`m`秒内数据集存在`n`次修改时，自动触发`bgsave`

默认如下配置：

```shell
save 900 1：表示900 秒内如果至少有 1 个 key 的值变化，则保存
save 300 10：表示300 秒内如果至少有 10 个 key 的值变化，则保存
save 60 10000：表示60 秒内如果至少有 10000 个 key 的值变化，则保存
```

当然如果你只是用`Redis`的缓存功能，不需要持久化，那么你可以注释掉所有的 `save` 行来停用保存功能。可以直接一个空字符串来实现停用：`save` ""

　　- **stop-writes-on-bgsave-error ：**默认值为`yes`。当启用了`RDB`且最后一次后台保存数据失败，`Redis`是否停止接收数据。这会让用户意识到数据没有正确持久化到磁盘上，否则没有人会注意到灾难（`disaster`）发生了。如果`Redis`重启了，那么又可以重新开始接收数据了　　

-  **rdbcompression ；**默认值是`yes`。对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，`redis`会采用`LZF`算法进行压缩。如果你不想消耗`CPU`来进行压缩的话，可以设置为关闭此功能，但是存储在磁盘上的快照会比较大。　

- **rdbchecksum ：**默认值是`yes`。在存储快照后，我们还可以让`redis`使用`CRC64`算法来进行数据校验，但是这样做会增加大约`10%`的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能。　

- **dbfilename ：**设置快照的文件名，默认是 `dump.rdb`　

- **dir：**设置快照文件的存放路径，这个配置项一定是个目录，而不能是文件名。默认是和当前配置文件保存在同一目录。

　　也就是说通过在配置文件中配置的 `save`方式，当实际操作满足该配置形式时就会进行 `RDB` 持久化，将当前的内存快照保存在 `dir` 配置的目录中，文件名由配置的 `dbfilename` 决定

















### AOF





#### AOF重写





### 对比







### Reference

- https://www.cnblogs.com/ysocean/p/9114268.html#_label0
- https://www.cnblogs.com/yangming1996/p/12152090.html
- https://segmentfault.com/a/1190000016021217