## 正则表达式如何匹配3的倍数?

**先说段子**：从前本来有一个问题，你决定选择用正则来解决，好了，现在你有两个问题了。。。

回到本文的主题，一拿到这个问题，用正则来处理，显然看起来有点无从下手，不知如何去做，看了知乎@Belleve大神给的[答案](https://www.zhihu.com/question/24824487)，写的实在是太好了，我按自己的理解，稍微加工了下，下面是正文:

```java
^[0369]* (
  (
    [147][0369]*
  | [258][0369]*[258][0369]*
  ) ([147][0369]*[258][0369]*)* (
    [258][0369]*
 
  | [147][0369]*[147][0369]*
  )
| [258][0369]*[147][0369]* )* $
```

上面的这个是其中的一个答案，是采用有限自动机得到的，可以匹配到任意的十进制数

### 有限状态机



![image-20211201100827350](/Users/frankcooper/Library/Application Support/typora-user-images/image-20211201100827350.png)

### 推导过程

其实，写一个正则匹配 10 进制下 n 的倍数的思路是这样：

- 构造一个有 n 个状态的 $DFA$，状态为 $q_0,q_1...q_{n-1}$，其中起始和接受状态都是$q_0$。DFA 中 $q_k$的含义是「当前读入的数可以被 n 除余 k」(其中n是答案要求的谁的倍数，如果是3的倍数，n则等于3，k即余数，如上图中，A余0，B余1，C余2，因为是3的倍数，所有的数的余数只有0，1，2这三种)。

- 关于$DFA$:正则引擎主要可以分为基本不同的两大类：一种是$DFA$（相当电动机），另一种是$NFA$（相当于汽油机）而采用$DFA$的工具主要有$egrep$、$awk$、$lex$和$flex$。也有些系统采用了混合引擎，它们会根据任务的不同选择合适的引擎（甚至对同一表 达式中的不同部分采用不同的引擎，以求得功能与速度之间的最佳平 衡）

  

  ![image-20211201091733589](/Users/frankcooper/Library/Application Support/typora-user-images/image-20211201091733589.png)

- 对每个$q_k$和$m\in{0,1,2,3,4,5,6,7,8,9}$，计算$r=(10*k+m)$   $mod$  $n$构造一条的转移边$q_k\quad\underrightarrow{m} \quad q_r$  如上图中：

  - 如$q_0\quad\underrightarrow{m} \quad q_2$也就是从A转移到C：

  ```java
  r =(10*k+m) mod n => 2 = (10*0 + m) mod 3
  得到 m  = {2,5,8}
  ```

  - 如$q_0\quad\underrightarrow{m} \quad q_1$也就是从A转移到B：

  ```java
  r =(10*k+m) mod n => 1 = (10*0 + m) mod 3
  得到 m  = {1,4,7}
  ```

  - 如$q_0\quad\underrightarrow{m} \quad q_0$也就是从A转移到A：

  ```java
  r =(10*k+m) mod n => 0 = (10*0 + m) mod 3
  得到 m  = {0,3,6,9}
  ```

接下来是如何从上图的自动状态机得到想要的正则表达式：

记A为终止到状态A的字符串集合，BC同理，可以得到下面三个方程:

```java
A = A[0369] | B[258] | C[147]  |
B = A[147] | B[0369] | C[258]
C = A[258] | B[147]  | C[0369]
```

- A可以从A自己的状态转化而来，也可以从B的状态，C的状态转换而来，其他同理

根据左递归消除（见下一节），可以推导出如下形式的方程

```text
L = LU|V  => L = VU*
```

因此上面方程可以修改为

```java
A = (| B[258] | C[147])[0369]* (1)
B = (  A[147] | C[258])[0369]* (2)
C = (  A[258] | B[147])[0369]* (3)
```

将 (3) 代入 (1) (2) 得

```java
A = (| B[258] | (A[258] | B[147])[0369]*[147])[0369]* (4)
B = (  A[147] | (A[258] | B[147])[0369]*[258])[0369]* (5)
```

用分配律展开 (5) 中的竖线得到

```java
B = A[147][0369]* | A[258][0369]*[258][0369]* | B[147][0369]*[258][0369]*
=> 
B = A[147][0369]*([147][0369]*[258][0369]*)*  | A[258][0369]*[258][0369]*([147][0369]*[258][0369]*)*
```

把它代入 (4) 得

```java
A = (| B[258] | (A[258] | B[147])[0369]*[147])[0369]*       (4)
  =   [0369]* 
    | B[258][0369]*
    | A[258][0369]*[147][0369]*
    | B[147][0369]*[147][0369]* 
  =   [0369]* 
    | A[147][0369]*([147][0369]*[258][0369]*)*[258][0369]*
    | A[258][0369]*[258][0369]*([147][0369]*[258][0369]*)*[258][0369]*
    | A[258][0369]*[147][0369]*
    | A[147][0369]*([147][0369]*[258][0369]*)*[147][0369]*[147][0369]* 
    | A[258][0369]*[258][0369]*([147][0369]*[258][0369]*)*[147][0369]*[147][0369]* 
  = [0369]* (
                  [147][0369]*([147][0369]*[258][0369]*)*[258][0369]*
    | [258][0369]*[258][0369]*([147][0369]*[258][0369]*)*[258][0369]*
    |             [147][0369]*([147][0369]*[258][0369]*)*[147][0369]*[147][0369]* 
    | [258][0369]*[258][0369]*([147][0369]*[258][0369]*)*[147][0369]*[147][0369]*
    | [258][0369]*[147][0369]* )*
  = [0369]* (
      (
        [147][0369]*
      | [258][0369]*[258][0369]*
      ) ([147][0369]*[258][0369]*)* (
        [258][0369]*
 
      | [147][0369]*[147][0369]*
      )
    | [258][0369]*[147][0369]* )*
```

### 左递归消除

#### 直接左递归

下面给出两个文法的例子：

```java
G[S]:
S→S*a|a|(S)

G[E]:
E→E+M|E^|M
M→PbM|P
P→cEd|#
```

不难发现这两个文法中都只含有直接左递归，G[S]中的递归产生式为S→S*a，G[E]中的递归产生式为E→E+M以及E→E^.这类文法的直接左递归消除可以直接使用上述公式，消除之后的无直接左递归文法如下

```java
G[S]:
S→aT|(S)T
T→*aT|ε

G[E]:
E→MT
T→+MT|^T|ε
M→PbM|P
P→cEd|#
```

#### 复杂左递归

但如果遇到文法不是直接左递归的，它可能是间接左递归的，或者二者兼具，我们就无法直接使用上述公式来消除其左递归。但我们可以证明，对于一个不含有P→P这样的"回路产生式"以及P→ε这样的空产生式的文法，我们是一定可以消除其左递归的。给出两个这样的文法示例：

```java
G[S]:
S→Qc|c
Q→Rb|b
R→Sa|a

G[L]:
L→La|Tb|c
T→L+|T*|f
```

**「正则大法好」：正则技术交流群，群内有不少大佬，可以提需求，迅速有响应，也欢迎拉人~**

![image-20211202081123443](/Users/frankcooper/Library/Application Support/typora-user-images/image-20211202081123443.png)

### 往期精彩

[正则表达式漫谈](http://mp.weixin.qq.com/s?__biz=MzIyMjczODEyMQ==&mid=2247484463&idx=1&sn=3a3fc2e4e1f49e4c83ebc48f8f61718a&chksm=e829a789df5e2e9f9e792e2e4373ecf1a90934755b184b206864832f9300f1a79a1ad1c9168c#rd)

