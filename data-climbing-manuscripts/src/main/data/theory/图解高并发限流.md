## 图解高并发限流

### 背景

在开发高并发系统时有三把利器用来保护系统：缓存、降级和限流

- 缓存：缓存的目的是提升系统访问速度和增大系统处理容量
- 降级：降级是当服务器压力剧增的情况下，根据当前业务情况及流量对一些服务和页面有策略的降级，以此释放服务器资源以保证核心任务的正常运行
- 限流：限流的目的是通过对并发访问/请求进行限速，或者对一个时间窗口内的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务、排队或等待、降级等处理

我们经常在调别人的接口的时候会发现有限制，比如微信公众平台接口、高等API等等，对方会限制每天最多调多少次或者每分钟最多调多少次

### 限流算法

![image-20210826201520673](/Users/frankcooper/Library/Application Support/typora-user-images/image-20210826201520673.png)

#### 计数器

> **在指定周期内累加访问次数，当访问次数达到设定的阈值时，出发限流策略，当进入下一个时间周期时会将访问次数清零**

优缺点：实现起来比较简单，但会出现「临界问题」，如上图，短时间内的访问量超过1000，大于了规定的10s内的访问量不超过500的限定

#### 滑动窗口

> **将固定窗口中分割出多个小时间窗口，分别在每个小的时间窗口中记录访问次数，然后根据时间将窗口往前滑动并删除过期的小时间窗口**

优缺点：实现简单，但存在**突刺现象**(如果在单位时间10秒内的前100ms，通过了500个请求，则后面的990ms都无法接受任何请求，也就无法应对短时间高并发)

![image-20210826201554116](/Users/frankcooper/Library/Application Support/typora-user-images/image-20210826201554116.png)

#### 漏桶

> **水流速度不定， 漏桶水滴的流出速度始终保持不变**

优缺点：起到削峰的作用，可以应对突发流量，不足之处是无法应对突发的并发流量

#### 令牌桶

> **令牌桶是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法**

- 当请求速度大于令牌的生成速度，令牌会被拿完后限流
- 当请求速度等于令牌的生成速度，流量正常稳定处理
- 当请求速度小于令牌的生成速度，请求可以被正常处理，且多余的令牌被丢弃





### RateLimiter源码赏析





### Reference

- [四种限流算法图解](https://blog.csdn.net/hbuxiaofei/article/details/117222003)
- [Java架构师之高并发限流](https://www.bilibili.com/video/BV1x4411R7i6?p=5)

- [令牌桶算法限流](https://www.cnblogs.com/cjsblog/p/9379516.html)

