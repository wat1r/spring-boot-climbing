## 分布式事务介绍

### 基本事务的特性

#### ACID

- **原子性（Atomicity）**：要么全部完成，要么全部失败

- **一致性（Consistency）**：事务开始和完成时，数据必须保持一致的状态，数据库的完整性约束没有被破坏。比如A给B转账，不论转账事务是否成功，两者存款的总额不变

- **隔离性（Isolation）**：多个事务并发访问时，事务之间是隔离的，一个事务不能影响到其他事务的结果 ，不能看到其他事务运行时中间某个时刻的数据。

- **持久性（Durability）**：事务完成后，该事务对数据库所作的更改便持久地保存在数据库中，并不会被回滚







### 2PC





**DTP（Distributed Transaction Processing）**分布式事务处理模型规定了分布式事务的模型设计

![image-20210810092405245](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\theory\分布式事务介绍.assets\image-20210810092405245.png)

- **AP**（Application Program）：即应用程序，可以理解为使用 DTP 分布式事务的程序。
- **RM**（Resource Manager）：即资源管理器，可以理解为事务的参与者，一般情况下是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。
- **TM**（Transaction Manager）：事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务生命周期，并协调各个 RM。**全局事务**是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务





![image-20210810100509081](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\theory\分布式事务介绍.assets\image-20210810100509081.png)





在2PC协议中，需要一个中心化**协调者节点coordinator**和N个**参与者节点partcipant**

#### 2PC出现单点问题的三种情况

1.**协调者正常,参与者宕机**

 由于 **协调者** 无法收集到所有 **参与者** 的反馈，会陷入阻塞情况。

 **解决方案**:引入超时机制,如果协调者在超过指定的时间还没有收到参与者的反馈,事务就失败,向所有节点发送终止事务请求。

2.**协调者宕机,参与者正常**

 无论处于哪个阶段，由于**协调者宕机**，无法发送提交请求，所有处于执行了操作但是未提交状态的参与者都会陷入阻塞情况.

 **解决方案**:引入协调者备份,同时协调者需记录操作日志.当检测到协调者宕机一段时间后，协调者备份取代协调者，并读取操作日志，向所有参与者询问状态。

3.**协调者和参与者都宕机**

- 3.1.**发生在第一阶段**： 因为第一阶段，所有参与者都没有真正执行commit，所以只需重新在剩余的参与者中重新选出一个协调者，新的协调者在重新执行第一阶段和第二阶段就可以了。
- 3.2.**发生在第二阶段 并且 挂了的参与者在挂掉之前没有收到协调者的指令**。这种情形下，新的协调者重新执行第一阶段和第二阶段操作。
- 3.3.**发生在第二阶段 并且 有部分参与者已经执行完commit操作**。就好比这里订单服务A和支付服务B都收到**协调者** 发送的commit信息，开始真正执行本地事务commit,但突发情况，Acommit成功，B确挂了。这个时候目前来讲数据是不一致的。虽然这个时候可以再通过手段让他和协调者通信，再想办法把数据搞成一致的，但是，这段时间内他的数据状态已经是不一致的了， 2PC 无法解决这个问题。



 



### 3PC

相比于2PC的改动点

- 引入超时机制，同时在协调者和参与者中都引入超时机制

- 在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点的状态是一致的

![image-20210810095237717](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\theory\分布式事务介绍.assets\image-20210810095237717.png)

- **CanCommit**：**协调者coordinator**向全部**参与者partcipant**发送CanCommit命令，询问是否能够执行事务提交操做。若是所有响应YES则进入下一个阶段。

- **PreCommit**：协调者向全部参与者发送**PreCommit**命令，询问是否能够进行事务的预提交操做，参与者接收到PreCommit请求后，如参与者成功的执行了事务操做，则返回**Yes**响应，进入最终**commit**阶段。一旦参与者中有向协调者发送了`No`响应，或因网络形成超时，协调者没有接到参与者的响应，协调者向全部参与者发送**abort**请求，参与者接受**abort**命令执行事务的中断。

- **DoCommit**： 在前两个阶段中全部参与者的响应反馈均是**YES**后，协调者向参与者发送**DoCommit**命令正式提交事务，如协调者没有接收到参与者发送的**ACK**响应，会向全部参与者发送**abort**请求命令，执行事务的中断。



### TCC

![image-20210810100438982](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\theory\分布式事务介绍.assets\image-20210810100438982.png)







### Reference

- https://www.shangmayuan.com/a/3f60b75690d943d39a6b62fa.html
- https://www.jianshu.com/p/60a100eee74a
- https://zhuanlan.zhihu.com/p/376378186
- https://www.cnblogs.com/qdhxhz/p/11167025.html