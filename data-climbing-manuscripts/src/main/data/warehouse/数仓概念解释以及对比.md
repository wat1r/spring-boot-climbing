## 数仓概念解释以及对比



### OLTP与OLAP

联机事务处理OLTP，**On-Line Transaction processing**，联机分析处理OLAP   **On-Line Analytical Processing**
**OLTP**是传统的关系型数据库的主要应用，主要是基本的、日常的事务处理，例如银行交易；**OLTP** 系统强调数据库内存效率，强调内存各种指标的命令率，强调绑定变量，强调并发操作；
**OLAP**是数据仓库系统的主要应用，支持复杂的分析操作，侧重决策支持，并且提供直观易懂的查询结果；**OLAP** 系统则强调数据分析，强调SQL执行市场，强调磁盘I/O，强调分区等。

![image-20210112193938151](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20210112193938151.png)



OLTP系统最容易出现瓶颈的地方就是CPU与磁盘子系统。
（1）CPU出现瓶颈常表现在逻辑读总量与计算性函数或者是过程上，逻辑读总量等于单个语句的逻辑读乘以执行次数，如果单个语句执行速度虽然很快，但是执行次数非常多，那么，也可能会导致很大的逻辑读总量。设计的方法与优化的方法就是减少单个语句的逻辑读，或者是减少它们的执行次数。另外，一些计算型的函数，如自定义函数、decode等的频繁使用，也会消耗大量的CPU时间，造成系统的负载升高，正确的设计方法或者是优化方法，需要尽量避免计算过程，如保存计算结果到统计表就是一个好的方法。
（2）磁盘子系统在OLTP环境中，它的承载能力一般取决于它的IOPS处理能力. 因为在OLTP环境中，磁盘物理读一般都是db file sequential read，也就是单块读，但是这个读的次数非常频繁。如果频繁到磁盘子系统都不能承载其IOPS的时候，就会出现大的性能问题。

 OLTP比较常用的设计与优化方式为Cache技术与B-tree索引技术，Cache决定了很多语句不需要从磁盘子系统获得数据，所以，Web cache与Oracle data buffer对OLTP系统是很重要的

 OLAP系统，有的时候也叫DSS决策支持系统，就是我们说的数据仓库。在这样的系统中，语句的执行量不是考核标准，因为一条语句的执行时间可能会非常长，读取的数据也非常多。所以，在这样的系统中，考核的标准往往是磁盘子系统的吞吐量（带宽），如能达到多少MB/s的流量。
  磁盘子系统的吞吐量则往往取决于磁盘的个数，这个时候，Cache基本是没有效果的，数据库的读写类型基本上是db file scattered read与direct path read/write。应尽量采用个数比较多的磁盘以及比较大的带宽，如4Gb的光纤接口。
**在OLAP系统中，常使用分区技术、并行技术。**



### 数仓的作用

数据仓库大致可以分为以下一些作用：

-  进行交互式/即席查询（**ad-hoc**）；
-  用于报表类查询（**BI Reporting**）；
-  进行数据分析类查询（**Data Analytics**）；
- 用于数据挖掘类查询（**Data Mining**）；





#### ODS(Operational Data Store)数据运营层

- 最接近数据源数据的一层，数据源的数据经过ETL后，进入本层，这一层的数据不等同于原始数据
- ODS层数据有如下几个特征：
  - 1.面向主题的：进入ODS的数据是来源于各个操作型数据库以及其他外部数据源，数据进入ODS前必须经过 ETL过程（抽取、清洗、转换、加载等）。
  - 2.集成的：ODS的数据来源于各个操作型数据库，同时也会在数据清理加工后进行一定程度的综合。
  - 3.可更新的：可以联机修改。这一点区别于数据仓库
  - 4. 当前或接近当前的："当前"是指数据在存取时刻是最新的，"接近当前"是指存取的数据是最近一段时间得到的。





DW（Data Warehouse）数据仓库层

DWD（Data Warehouse Detail）数据明细层

- 是数据仓库的细节数据层，是对STAGE层数据进行沉淀，减少了抽取的复杂性，同时ODS/DWD的信息模型组织主要遵循企业业务事务处理的形式，将各个专业数据进行集中，明细层跟STAGE层的粒度一致，属于分析的公共资源，本层数据的生成方式：部分数据直接来自kafka，部分数据为接口层数据与历史数据合成。





DWM（Data WareHouse Middle）数据中间层（DWB(Data WareHouse Basis)）

> 是对DWD(数据明细层)的生产数据进行综合和汇总统计(可以把复杂的清洗，处理包含，如根据PV日志生成的会话数据)。DWM(数据中间层)与DWD(数据明细层)的主要区别在于二者的应用领域不同，DWD(数据明细层)的数据来源于生产系统，并未对一些不可预见的需求而进行沉淀，DWD(数据明细层)则面向分析型应用进行细粒度的统计和沉淀

- 数据生成方式：由DWD层（数据明细层）按照一定的业务需求生成中间表。DWD层（数据明细层）需要复杂清洗的数据和需要MR处理的数据也经过处理后接入到DWM（数据中间层）

- 日志：存储方式可以是内表，Parquet文件格式，删除方式是长久存储。
- Schema：一般按天创建分区，没有时间概念的按具体业务选择分区字段。

- 库与表命名：dwb.table_name。

- 旧数据更新方式：覆盖。

  

DWS（Data WareHouse Service）数据服务层（DM(Data Market)）

数据集市或者宽表，按照业务划分，如流量、订单、用户等，生成字段比较多的宽表，用于提供后续的业务查询，OLAP分析，数据分发等

- 数据生成方式：由DWD层（数据明细层）和DWM（数据中间层）数据计算生成。
- 日志：存储方式使用Impala内表，Parquet文件格式，删除方式是长久存储。
- Schema：一般按天创建分区，没有时间概念的按具体业务选择分区字段。
- 库与表命名：dm.table_name。
- 旧数据更新方式：覆盖。





APP（数据产品层）

提供给数据产品和数据分析使用的数据，一般会存放在 ES、Mysql 等系统中供线上系统使用，也可能会存在 Hive 或者 Druid 中供数据分析和数据挖掘使用，数据报表BI一般放在这里。

> APP（数据产品层）是根据业务需要，由前面三层数据统计而出的结果，可以直接提供查询展现，或导入至Mysql中使用

- 数据生成方式：由DWD数据明细层、DWM(数据中间层)，数据服务层(DWS)生成，一般要求数据主要来源于DM(数据集市)。
- 日志：存储方式使用Impala内表，Parquet文件格式，删除方式是长久存储。
- Schema：一般按天创建分区，没有时间概念的按具体业务选择分区字段。
- 库与表命名：app.table_name。
- 旧数据更新方式：覆盖。





### 多维数据查询 DIM

#### 事实表

**事实表（Fact Table）用来记录具体事件，包含了每个事件的具体要素，以及具体发生的事情**。事实表是主干，简明扼要得介绍一个事实。例子中就通过一条事实表记录说明了某个地方（地域ID）的某人（用户ID）在某个时间（时间ID）通过某种方式（支付ID）买了某产品（产品ID）。

#### 维度表

**维度表（Dimension Table ）是依赖事实表而存在的**，“皮之不存，毛将焉附”，没有事实表数据，维度表也就没有存在的意义。**每个维度表都是对事实表中的每个列/字段进行展开描述。**
比如事实表中的用户ID，就可以进一步展开成一张维度表，记录该用户ID实体的用户名、联系信息、地址信息、年龄、性别和注册方式等等；



#### 多维分析中的常用操作


下钻（Drill-down）：在维的不同层次间的变化，从上层降到下一层，或者说是将汇总数据拆分到更细节的数据，比如通过对2010年第二季度的总销售数据进行钻取来查看2010年第二季度4、5、6每个月的消费数据，如上图；当然也可以钻取浙江省来查看杭州市、宁波市、温州市……这些城市的销售数据。

上卷（Roll-up）：钻取的逆操作，即从细粒度数据向高层的聚合，如将江苏省、上海市和浙江省的销售数据进行汇总来查看江浙沪地区的销售数据，如上图。

切片（Slice）：选择维中特定的值进行分析，比如只选择电子产品的销售数据，或者2010年第二季度的数据。

切块（Dice）：选择维中特定区间的数据或者某批特定值进行分析，比如选择2010年第一季度到2010年第二季度的销售数据，或者是电子产品和日用品的销售数据。

旋转（Pivot）：即维的位置的互换，就像是二维表的行列转换，如图中通过旋转实现产品维和地域维的互换。

![image-20210112211625168](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20210112211625168.png)







数据分层



![image-20211014092439663](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20211014092439663.png)

- DWM(数据中间层)：从ODS层(数据运营层)中对用户的行为做一个初步的汇总，抽象出来一些通用的维度：时间、ip、id，并根据这些维度做一些统计值，比如用户每个时间段在不同登录ip购买的商品数等。这里做一层轻度的汇总会让计算更加的高效，在此基础上如果计算仅7天、30天、90天的行为的话会快很多。我们希望80%的业务都能通过我们的DWS层计算，而不是ODS。
- DWD：这一层主要解决一些数据质量问题和数据的完整度问题。比如用户的资料信息来自于很多不同表，而且经常出现延迟丢数据等问题，为了方便各个使用方更好的使用数据，我们可以在这一层做一个屏蔽。（汇总多个表）
- DIM：如国家代码和国家名、地理位置、中文名、国旗图片等信息就存在DIM层中。
- TMP：每一层的计算都会有很多临时表，设一个TMP层来存储数据仓库的临时表





举例

![image-20211014093443324](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20211014093443324.png)





## 对比

DW(Data Warehouse)数据仓库与事务型数据库

![image-20211014095314923](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20211014095314923.png)



DW(Data Warehouse)数据仓库与DM(Data Market)数据集市

![image-20211014095730615](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20211014095730615.png)



DW(Data Warehouse)数据仓库与DL(Data Lake)数据湖



![image-20211014100031327](D:\Dev\SrcCode\spring-boot-climbing\data-climbing-manuscripts\src\main\data\warehouse\数仓概念解释以及对比.assets\image-20211014100031327.png)





### Reference

- https://www.cnblogs.com/hhandbibi/p/7118740.html
- https://blog.51cto.com/76287/885475
- [各个OLAP 引擎详细对比介绍](https://zhuanlan.zhihu.com/p/141145481)
- [数据仓库、数据湖、流批一体，终于有大神讲清楚了](https://zhuanlan.zhihu.com/p/141182199?from_voters_page=true)
- [CAP理论的理解](https://www.cnblogs.com/mingorun/p/11025538.html)
- [OLAP数仓入门问答-基础篇](https://zhuanlan.zhihu.com/p/144926830)
- [网站数据分析](http://webdataanalysis.net/)
- [主流OLAP系统对比总结](https://zhuanlan.zhihu.com/p/38767561)
- [CAP理论](https://blog.csdn.net/movie14/article/details/82736873)
- [分布式系统的CAP理论](https://www.hollischuang.com/archives/666)
- [[数据仓库]分层概念,ODS,DM,DWD,DWS,DIM的概念](https://blog.csdn.net/pmdream/article/details/113601956)

- [数据仓库中的ODS DW DM理解](https://www.jianshu.com/p/9bcfab62644f)



